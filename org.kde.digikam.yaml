id: org.kde.digikam
base: io.qt.qtwebengine.BaseApp
base-version: '5.14'
runtime: org.kde.Platform
runtime-version: '5.14'
sdk: org.kde.Sdk
command: digikam
rename-icon: digikam
finish-args:
- --share=ipc
- --socket=cups
- --socket=x11
- --device=dri
- --socket=wayland
- --filesystem=host
- --talk-name=org.freedesktop.FileManager1
- --talk-name=org.freedesktop.Flatpak
cleanup:
- /include
build-options:
  no-debuginfo: true
separate-locales: false
modules:

- shared-modules/glu/glu-9.json

- name: eigen
  buildsystem: cmake-ninja
  builddir: true
  cleanup: ['*']
  sources:
  - type: archive
    url: https://gitlab.com/libeigen/eigen/-/archive/3.3.7/eigen-3.3.7.tar.bz2
    sha256: 685adf14bd8e9c015b78097c1dc22f2f01343756f196acdc76a678e1ae352e11

- name: ImageMagick
  config-opts:
  - --disable-static
  cleanup:
  - /bin
  - /share/doc
  sources:
  - type: archive
    url: https://imagemagick.org/download/releases/ImageMagick-7.0.10-10.tar.xz
    sha256: df1a37b73aa49423abb422c2150a0e1436920ba50dfc4377c6a3793f9826e5f1

- name: lensfun
  buildsystem: cmake-ninja
  builddir: true
  config-opts:
  - -DCMAKE_BUILD_TYPE=Release
  sources:
  - type: archive
    url: https://downloads.sourceforge.net/project/lensfun/0.3.95/lensfun-0.3.95.tar.gz
    sha256: 82c29c833c1604c48ca3ab8a35e86b7189b8effac1b1476095c0529afb702808

- name: marble
  buildsystem: cmake-ninja
  builddir: true
  config-opts:
  - -DCMAKE_BUILD_TYPE=Release
  - -DBUILD_TESTING=OFF
  - -DBUILD_MARBLE_EXAMPLES=OFF
  - -DBUILD_MARBLE_TESTS=OFF
  - -DMOBILE=OFF
  sources:
  - type: archive
    url: https://download.kde.org/stable/release-service/20.04.0/src/marble-20.04.0.tar.xz
    sha256: 045c94eeb11269d79145ac754f258320fa6d3eeb91ffdd6b88c0c214c6e8eb48

- name: ffmpeg
  config-opts:
    - --enable-rpath
    - --enable-gpl
    - --disable-static
    - --enable-shared
    - --disable-doc
    - --disable-programs
  cleanup: [/share]
  sources:
    - type: archive
      url: https://www.ffmpeg.org/releases/ffmpeg-4.2.2.tar.xz
      sha256: cb754255ab0ee2ea5f66f8850e1bd6ad5cac1cd855d0a2f4990fb8c668b0d29c

- name: QtAV
  buildsystem: cmake-ninja
  builddir: true
  config-opts:
  - -DCMAKE_BUILD_TYPE=Release
  - -DBUILD_EXAMPLES=OFF
  - -DBUILD_PLAYERS=OFF
  - -DBUILD_TESTS=OFF
  - -DBUILD_QT5OPENGL=ON
  sources:
  - type: git
    url: https://github.com/wang-bin/QtAV.git
    commit: 11a13bf0717dff5273c6abf2d42d5fee13796f8e

- name: exiv2
  buildsystem: cmake-ninja
  builddir: true
  config-opts:
  - -DCMAKE_BUILD_TYPE=Release
  - -DEXIV2_ENABLE_VIDEO=ON
  - -DEXIV2_BUILD_SAMPLES=OFF
  - -DEXIV2_ENABLE_NLS=ON
  sources:
  - type: archive
    url: https://www.exiv2.org/builds/exiv2-0.27.2-Source.tar.gz
    sha256: 2652f56b912711327baff6dc0c90960818211cf7ab79bb5e1eb59320b78d153f

- name: opencv
  buildsystem: cmake-ninja
  builddir: true
  config-opts:
  - -DCMAKE_BUILD_TYPE=Release
  - -DENABLE_TESTING=OFF
  - -DBUILD_LIST=dnn,flann,imgcodecs,objdetect,calib3d,features2d
  sources:
  - type: archive
    url: https://github.com/opencv/opencv/archive/4.3.0.tar.gz
    sha256: 68bc40cbf47fdb8ee73dfaf0d9c6494cd095cf6294d99de445ab64cf853d278a

- name: boost
  buildsystem: simple
  build-commands:
  - ./bootstrap.sh --prefix=/app --with-libraries=graph
  - ./b2 install variant=release link=shared runtime-link=shared cxxflags="$CXXFLAGS" linkflags="$LDFLAGS" -j $FLATPAK_BUILDER_N_JOBS
  sources:
  - type: archive
    url: https://dl.bintray.com/boostorg/release/1.73.0/source/boost_1_73_0.tar.bz2
    sha256: 4eb3b8d442b426dc35346235c8733b5ae35ba431690e38c6a8263dce9fcbb402

- name: mariadb
  buildsystem: cmake-ninja
  builddir: true
  config-opts:
  - -DCMAKE_BUILD_TYPE=Release
  - -DINSTALL_SCRIPTDIR=/app/bin
  - -DWITH_UNIT_TESTS=OFF
  sources:
  - type: archive
    url: https://ftp.osuosl.org/pub/blfs/conglomeration/mariadb/mariadb-10.4.12.tar.gz
    sha256: fef1e1d38aa253dd8a51006bd15aad184912fce31c446bb69434fcde735aa208

- name: qt5-mysql
  buildsystem: qmake
  builddir: true
  subdir: src/plugins/sqldrivers
  no-make-install: true
  post-install:
  - sed -e 's|$(INSTALL_ROOT)/usr|/app|g' -i mysql/Makefile
  - make -C mysql install
  sources:
  - type: archive
    url: http://download.qt.io/archive/qt/5.14/5.14.2/submodules/qtbase-everywhere-src-5.14.2.tar.xz
    sha256: 48b9e79220941665a9dd827548c6428f7aa3052ccba8f4f7e039a94aa1d2b28a

- name: digikam
  buildsystem: cmake-ninja
  builddir: true
  config-opts:
  - -DCMAKE_BUILD_TYPE=Release
  - -DBUILD_TESTING=OFF
  - -DENABLE_KFILEMETADATASUPPORT=ON
  - -DENABLE_MEDIAPLAYER=ON
  - -DENABLE_AKONADICONTACTSUPPORT=OFF
  - -DENABLE_MYSQLSUPPORT=ON
  - -DENABLE_APPSTYLES=ON
  - -DENABLE_QWEBENGINE=ON
  - -DOpenGL_GL_PREFERENCE=GLVND
  sources:
  - type: script
    dest-filename: mysqld.sh
    commands: [exec flatpak-spawn --host mysqld "$@"]
  - type: script
    dest-filename: mysql_install_db.sh
    commands: [exec flatpak-spawn --host mysql_install_db "$@"]
  - type: script
    dest-filename: darktable.sh
    commands: [exec flatpak-spawn --host flatpak run org.darktable.Darktable "$@"]
  - type: script
    dest-filename: rawtherapee.sh
    commands: [exec flatpak-spawn --host flatpak run com.rawtherapee.RawTherapee  "$@"]
  - type: archive
    url: https://download.kde.org/stable/digikam/6.4.0/digikam-6.4.0.tar.xz
    sha256: 775012ff515bdd25a0b894c95bf5d33e7122b523da9c0f3af260ec3eff498d6f
  - type: patch
    paths:
    - patches/digikam-initialize-imagemagick.patch
    - patches/digikam-opencv-4.2.patch
  - type: shell
    commands:
    - sed -i 's|/usr|/app|g' core/dplugins/generic/tools/jalbum/wizard/jalbumintropage.cpp
                             core/libs/database/utils/widgets/dbsettingswidget.cpp
                             core/libs/widgets/files/dbinaryiface.cpp
    - sed -i 's|/usr/local/share|/run/host/usr/share|g' core/libs/dimg/filters/icc/iccprofile.cpp
    # - install -D mysqld.sh /app/bin/mysqld
    # - install -D mysql_install_db.sh /app/bin/mysql_install_db
    - install -D darktable.sh /app/bin/darktable
    - install -D rawtherapee.sh /app/bin/rawtherapee

# cleanup-commands:
#   - cp /app/mariadb/bin/mysqld /app/bin
#   - cp /app/mariadb/scripts/mysql_install_db /app/bin